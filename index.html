<!DOCTYPE html>
<html>
<head>

<meta charset="utf-8">
<link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:200' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="index.css">
<style>

.subunit {fill: #F3F3F3;} 

</style>
    
</head>
<body>

<div><h1>Global dollar per gram values of cocaine salts</h1></div>
<div class ="button active" id = "buttonRetail">Retail</div>
<div class ="button" id = "buttonWholesale" >Wholesale</div>
<div id="svgContainer"></div>

<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script>

// mapping



d3.json("map.json", function (error, map) {
  
  var width = window.innerWidth,
    height = 700,
	svg = d3.select("div#svgContainer").append("svg")
	    .attr("width", width)
	    .attr("height", height);

  if (error) return console.error(error);

	var subunits = topojson.feature(map, map.objects.subunits),
		projection = d3.geo.mercator()
			.scale(200)
			.translate([width / 2, height / 1.775]),
		path = d3.geo.path()
    		.projection(projection);

    svg.selectAll(".subunit")
		    .data(subunits.features)
	    .enter().append("path")
		    .attr("class", function(d) { return "subunit " + d.id})
		    .attr("d", path);
	
	// data fetch and processing

	var countries = [],
		minRetailPrice = 1000000,
		maxRetailPrice = 0,
		minWholesalePrice = 1000000,
		maxWholesalePrice = 0;

	d3.json("cocaine.json", function (error, data) {

		data.features.forEach( function (country) {
		
			// build countries array

			countries.push({
				name: country.properties["Country name"],
				id: country.properties["Alpha-2"],
				retailPrice: +country.properties["Retail price"],
				wholesalePrice: +country.properties["Wholesale price"]/1000
			}) 

			// find min and max values

			if (country.properties["Retail price"] && +country.properties["Retail price"] < minRetailPrice) {
				minRetailPrice = +country.properties["Retail price"];
			}

			if (country.properties["Retail price"] && +country.properties["Retail price"] > maxRetailPrice) {
				maxRetailPrice = +country.properties["Retail price"];
			}

			if (country.properties["Wholesale price"] && +country.properties["Wholesale price"] < minWholesalePrice) {
				minWholesalePrice = +country.properties["Wholesale price"];
			}

			if (country.properties["Wholesale price"] && +country.properties["Wholesale price"] > maxWholesalePrice) {
				maxWholesalePrice = +country.properties["Wholesale price"];
			}

		});

		// kilo to gram

		minWholesalePrice = minWholesalePrice/1000;
		maxWholesalePrice = maxWholesalePrice/1000;

		// scales

		var retailScale = d3.scale.linear()
			.domain([minRetailPrice, maxRetailPrice])
			.range(["#B9EEAA", "#194400"]),
			wholesaleScale = d3.scale.linear()
			.domain([minWholesalePrice, maxWholesalePrice])
			.range(["#B9EEAA", "#2A5511"]);

		// scale colour countries

		function colorCountries (countries, selection) {
			countries.forEach( function (country) {
				if (selection === "Retail price") {
					d3.select(".subunit." + country.id)
						.style("fill", retailScale(country.retailPrice));
				}
				else {
					if (country.wholesalePrice === 0) {
						d3.select(".subunit." + country.id)
							.style("fill", "#F3F3F3")
					}
					else {
						d3.select(".subunit." + country.id)
							.style("fill", wholesaleScale(country.wholesalePrice));
					}
				}
			})
		}

		var selection = "Retail price";

		colorCountries(countries, selection)

		document.getElementById("buttonRetail").addEventListener("click", function () {
			selection = "Retail price";
			colorCountries(countries, selection);
		})

		document.getElementById("buttonWholesale").addEventListener("click", function () {
			selection = "Wholesale price";
			colorCountries(countries, selection);
		})
	});	

});

document.getElementById("buttonRetail").addEventListener("click", function () {
			document.getElementById("buttonRetail").classList.toggle('active');
			document.getElementById("buttonWholesale").classList.toggle('active');;
		});

document.getElementById("buttonWholesale").addEventListener("click", function () {
			document.getElementById("buttonRetail").classList.toggle('active');
			document.getElementById("buttonWholesale").classList.toggle('active');;
		});

</script>
</body>
</html>
